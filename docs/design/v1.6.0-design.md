# v1.6 Design Notes — External Lesson Sources & Provenance

**Project:** CloudPedagogy Course Engine  
**Version:** v1.6  
**Status:** Design record (implemented)  
**Audience:** Maintainers, contributors, governance reviewers

---

## 1. Purpose of this document

This document records the **design rationale, scope, and implementation intent** of the v1.6 release of `course-engine`.

It exists to:

- document *why* v1.6 was introduced
- explain *what changed* (and what did not)
- support future maintainers and auditors
- provide a reference point for future versions (v1.7+)

This is a **design record**, not end-user documentation.  
End users should refer to *End User Instructions (v1.6)*.

---

## 2. Problem statement (pre‑v1.6)

Prior to v1.6, lesson content had to be authored inline within `course.yml` using `content_blocks`.

This created several problems for real courses:

- large YAML files became hard to read and maintain
- lesson content could not be versioned independently
- reuse of lesson content across courses was awkward
- authors used ad-hoc pre-build scripts to split content
- silent or confusing failures occurred when layouts were incorrect

There was **no first-class support** for external lesson files, despite this being a common and reasonable authoring workflow.

---

## 3. Design goals for v1.6

v1.6 was designed to:

1. Support **external lesson source files** as a first-class feature
2. Preserve **deterministic builds** and reproducibility
3. Enforce **fail-fast guardrails** instead of silent behaviour
4. Maintain **backwards compatibility** where reasonable
5. Record **lesson provenance** for audit and governance contexts
6. Avoid introducing new build modes or flags

Non-goals:

- no partial lesson merging
- no dynamic includes
- no runtime content manipulation
- no breaking changes to output formats

---

## 4. Key feature: `lesson.source`

### 4.1 What was added

From v1.6, lessons may define a `source:` field instead of `content_blocks`.

Example:

```yaml
structure:
  modules:
    - id: module-1
      title: Foundations
      lessons:
        - id: lesson-01
          source: content/lessons/lesson-01.md
```

This allows lesson content to live in standalone Markdown (`.md`) or Quarto (`.qmd`) files.

Quarto (`.qmd`) lesson sources are treated as Markdown-compatible content and injected without execution.

---

### 4.2 Resolution rules

When `lesson.source` is used:

- Paths are resolved **relative to the `course.yml` file**
- The source file must be UTF‑8 text
- The lesson title is resolved in the following order:
  1. Explicit `title:` in `course.yml`
  2. First Markdown H1 (`# Heading`) in the source file
- The source file is injected internally as **a single Markdown content block**

This preserves a simple and deterministic internal model.

---

## 5. Guardrails (fail‑fast behaviour)

v1.6 introduces explicit validation rules:

- A lesson must define **exactly one of**:
  - `source`, or
  - `content_blocks`
- Defining both results in a build error
- Defining neither results in a build error
- If a title cannot be resolved, the build fails with a clear message
- Invalid top-level keys or layouts fail early

These guardrails replace previous silent or confusing behaviour and make failures explicit and actionable.

---

## 6. Manifest provenance additions

v1.6 extends `manifest.json` to record lesson source provenance.

When lessons are built from external source files, The manifest records, under `lesson_sources`, aggregated provenance information including:

- declared source path
- resolved absolute path
- SHA‑256 hash of lesson content
- count of sourced lessons

This supports:

- auditability
- governance review
- content integrity checks
- reproducibility over time

The manifest remains **per-course**, not per-lesson output.

---

## 7. Backwards compatibility

v1.6 is backwards compatible with:

- existing courses using `content_blocks`
- existing build and render commands
- existing output formats
- existing capability mapping workflows

No changes are required for courses that do not use `lesson.source`.

---

## 8. Why this design (and not alternatives)

Alternatives considered:

- mixing `source` with inline blocks → rejected (ambiguity)
- partial includes or templating → rejected (non-determinism)
- preprocessor plugins → rejected (complexity)
- auto-detecting lessons directory → rejected (implicit behaviour)

The chosen design favours:

- explicit declarations
- predictable resolution
- clear error messages
- governance-friendly artefacts

---

## 9. Impact on future versions

v1.6 establishes a clean foundation for:

- framework or taxonomy packs (v1.7+)
- lesson reuse libraries
- lineage assertions
- capability intent files
- structured governance extensions

Future versions can build on this without revisiting lesson ingestion mechanics.

---

## 10. Summary

v1.6 introduces **first-class support for external lesson source files**, with:

- strict validation
- deterministic resolution
- manifest-level provenance
- no breaking changes

This closes a major usability gap while preserving the engine’s core principles:
**clarity, traceability, and defensibility**.
