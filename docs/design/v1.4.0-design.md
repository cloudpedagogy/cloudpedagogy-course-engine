# CloudPedagogy Course Engine — v1.4 Design Specification

**Title:** Policy Profiles, External Policy Files, and Institutional Presets  
**Status:** Design locked  
**Introduced in:** v1.4  
**Applies to:** `course-engine validate`  
**Baseline:** v1.3.1  


---


## Design Decisions (Locked)

The following decisions are intentionally fixed for v1.4 to prevent design drift during implementation and future maintenance.

These decisions define the conceptual and behavioural contract of the v1.4 policy layer.  
Changing any of them would require a new design review.

- **Preset selection model**  
  Presets are selected via `--policy preset:<name>`.  
  Presets are treated as policy sources, not as a separate CLI concept.

- **Explain mode semantics**  
  The `--explain` flag is explain-only.  
  It resolves policy, profile, inheritance, and rules but does **not** execute validation.

- **Policy strictness**  
  Unknown or unsupported rule keys in policy files are treated as **errors**, not warnings.  
  Silent or permissive parsing is explicitly avoided to prevent false confidence.

---

## 1. Purpose

v1.4 introduces a policy layer above existing capability-mapping validation rules.

This enables:
- organisational ownership of validation thresholds
- multiple named validation profiles
- institutional example presets
- improved auditability and governance clarity

v1.4 does **not** change rule semantics, manifest structure, reporting logic, or build behaviour.

---

## 2. Design Principles

1. **Framework-agnostic**  
   Validation evaluates declared structure and traceability only.

2. **Policy is external**  
   Institutions define thresholds; the engine evaluates them.

3. **Defensible, not prescriptive**  
   “Pass” does not imply quality, effectiveness, or compliance.

4. **Audit-ready**  
   Every validation run must clearly show:
   - policy source
   - selected profile
   - resolved rules

5. **Backward compatible**  
   Running validation with no new flags behaves exactly like v1.3.

---

## 3. Scope

### In scope (v1.4)
- external policy files (YAML / JSON)
- named profiles within policies
- profile inheritance
- built-in example presets
- CLI profile selection
- `--list-profiles` and `--explain`
- policy context in validation output

### Explicitly out of scope
- scoring or grading
- semantic interpretation of evidence
- framework enforcement
- compliance certification
- automatic modification of builds

---

## 4. Core Concepts

### Policy file
A human-editable file defining one or more validation profiles.

### Profile
A named set of validation thresholds and toggles.

### Preset
A policy file shipped with the engine as an **example only**.

---

## 5. CLI Specification

```bash
course-engine validate <build-dir>
  [--policy <path | preset:name>]
  [--profile <profile-name>]
  [--list-profiles]
  [--explain]
  [--strict]
  [--json]
  [--out <file>]
```

### Flag semantics

| Flag | Meaning |
|-----|--------|
| `--policy` | Path to policy file or `preset:<name>` |
| `--profile` | Profile name within selected policy |
| `--list-profiles` | List available profiles and exit |
| `--explain` | Show resolved policy/profile/rules and exit |
| `--strict` | Treat rule violations as errors |
| `--json` | Machine-readable output |
| `--out` | Write output to file |

### Behavioural rules

- `--list-profiles` exits without running validation  
- `--explain` exits without running validation  
- `--strict` affects **severity only**, not thresholds  
- `--json` affects **output format only**

---

## 6. Policy Source Resolution

Policy sources are resolved in the following order:

1. External policy file (`--policy <path>`)
2. Engine preset (`--policy preset:<name>`)
3. Engine default profile (`baseline`)

If `--profile` is omitted:

- use `default_profile` from the selected policy, if present  
- otherwise use `baseline`

If a requested profile is not found, validation exits with an error and lists the available profile names.


## 7. Policy File Schema (v1)
### Required fields

```yaml
policy_version: 1
profiles:
  <profile-name>:
    rules:
      ...
```


### Optional metadata (informational only)

```yaml
policy_id: "example-policy"
policy_name: "Example Validation Policy"
owner: "Digital Education"
last_updated: "2026-01-09"
notes: "Thresholds for defensibility checks. Not a quality score."
default_profile: "qa-lite"
tags: ["qa", "governance"]
```

### Profile object

```yaml
profiles:
  qa-lite:
    description: "Minimum defensibility checks"
    extends: "baseline"
    rules:
      ...
```


## 8. Validation Rules (v1.4)

Only the following rule keys are permitted:

| Rule | Type | Meaning |
|-----|------|--------|
| `require_coverage.min_domains` | int | Minimum number of declared domains |
| `require_evidence.min_items_per_domain` | int | Minimum evidence items per domain |
| `min_coverage_items_per_domain` | int | Minimum coverage items per domain |
| `forbid_empty_domains` | bool | Flag declared domains with no coverage and no evidence |

Unknown rule keys are always treated as errors.

---

## 9. Profile Inheritance

- Profiles may extend one parent profile
- Maximum inheritance depth: **5**
- Cycles are forbidden
- Child rules override parent rules
- Metadata is not merged

---

## 10. Validation Pipeline

1. Load `manifest.json`
2. Build capability report (existing logic)
3. Load policy source
4. Resolve profile (inheritance applied)
5. Apply validation rules
6. Emit output


## 11. Output Requirements

### Human-readable output

Validation output includes a mandatory context header documenting which policy and profile were applied.


```text
Policy: policy.yml | Profile: strict-ci | Strict: ON
✔ Capability mapping validation passed
Mode: STRICT
Summary: 0 error(s) | 1 warning(s)
```

### JSON output (required fields)


```json
{
  "engine_version": "1.4.0",
  "timestamp": "...",
  "build_dir": "...",
  "manifest": "manifest.json",
  "policy_source": "...",
  "policy_id": "...",
  "profile": "...",
  "strict": true,
  "resolved_rules": { ... },
  "results": [ ... ],
  "summary": {
    "errors": 0,
    "warnings": 1
  }
}
```

## 12. `--explain`

The `--explain` flag does not run validation.

It outputs:

- policy source
- selected profile
- inheritance chain
- resolved rules
- strict mode status

Purpose: support governance review and CI debugging without executing validation.

---

## 13. Preset Policies

Presets are example policy files shipped with the engine.

They:

- are not compliance claims
- include explicit disclaimers
- are intended to be copied and adapted

v1.4 presets:

- `baseline`
- `higher-ed-example`
- `strict-ci`

Preset naming must avoid compliance implications.

---

## 14. Backward Compatibility

- Default validation behaviour is unchanged from v1.3
- Existing rule semantics are preserved
- No manifest changes are introduced

---

## 15. Non-goals (Reaffirmed)

v1.4 does not:

- judge pedagogical quality
- infer semantic alignment
- embed frameworks
- certify compliance

---

## 16. Final Statement

The v1.4 policy layer separates **engine behaviour** from **organisational meaning**.

The engine evaluates declared structure.  
Institutions define policy.  
Meaning remains external to the tool.

